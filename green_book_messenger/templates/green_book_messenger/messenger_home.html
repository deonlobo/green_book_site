{% extends 'green_book_app/base.html' %}

{% load static %}

<!-- https://colorhunt.co/palette/45526Cf4ce14127C56F8F5F1 -->
{% block messenger_css %}
<link rel="stylesheet" href="{% static 'green_book_messenger/css/styles.css' %}" />
{% endblock %}

{% block messenger_js %}
<script data-selected_conversation_uuid="{{selected_conversation_uuid}}" data-user_id="{{user_id}}"
  data-getusers_ajax="{% url 'get_users' %}" data-add_private_conversation='{% url "add_private_conversation" %}'
  data-toggle_conversation_pin="{% url 'toggle_conversation_pin' %}" data-csrf_token="{{ csrf_token }}"
  type="text/javascript" src="{% static 'green_book_messenger/js/messenger.js' %}"></script>
{% endblock %}

{% block messenger_html %}
<div id="messenger--container" class="messenger container-fluid position-relative overflow-hidden d-flex flex-column">
  <div id="messenger_private_conversation_model"
    class="messenger_private_conversation_model position-absolute w-100 h-100 ml-n4 zindex-modal">
    <div class="container mx-auto mt-4">
      <div class="row">
        <div class="col d-flex justify-content-start">
          <button type="button" id="private_converstation_close_button"
            class="btn private_converstation_close_button rounded-circle p-2">
            <svg width="27" height="25" viewbox="0 0 40 40">
              <path d="M 10,10 L 30,30 M 30,10 L 10,30" stroke="#f8f5f1" stroke-width="4" />
            </svg>
          </button>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <form id="add_private_conversation_form" method="post" action="{% url 'add_private_conversation' %}">
            <div class="d-flex align-items-center justify-content-between">
              <h1 class="m-0 p-2"><b>Start private conversation with </b> <span
                  class="badge rounded-pill mt-n2 name__badge" id="name__badge">.........</span>
              </h1>
              <div class="user_name_button ml-2">
                <button type="submit" id="private_converstation_add_button" class="btn rounded-circle p-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 25 25" width="27" height="25">
                    <path style="fill:#f8f5f1"
                      d="m17.5 5.999-.707.707 5.293 5.293H1v1h21.086l-5.294 5.295.707.707L24 12.499l-6.5-6.5z"
                      data-name="Right" />
                  </svg>
                </button>
              </div>
            </div>

            <div class="d-flex flex-row align-items-center">
              <div class="user_name_input input-group flex-grow-1">
                <input onkeyup="getUsersDebouce()" placeholder="Search Users........" type="text"
                  class="form-control rounded-pill m-0" type="text" name="user_name" id="user__name__input">
              </div>

            </div>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div id="search__result__container" class="search__result__container container p-0 pt-4 ">
          </div>
        </div>

      </div>
    </div>

  </div>
  <div class="row gx-2">
    <div class="messenger__header__left col-12 p-1">
      <div class="messenger__header__left__container d-flex justify-content-between align-items-center p-4">
        <span class="m-0 flex-grow-1 mr-2">
          <input id="messenger__search__input" type="text" class="form-control rounded-pill" id="message_input"
            placeholder="Search" />
        </span>
        <span class="messenger__header__add__button">
          <button id="add_user_btn" type="button" class="btn rounded-circle p-2 m-0 b-0">
            <svg id="add_user_btn_svg" width="25.4" height="22" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path d="M4 12H20M12 4V20" stroke="#f8f5f1" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
          <button id="add_group_btn" type="button" class="btn rounded-circle p-2 m-0 b-0">
            <svg id="add_user_btn_svg" width="25.4" height="22" viewBox="0 0 24 24" fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path d="M4 12H20M12 4V20" stroke="#f8f5f1" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
        </span>

      </div>
    </div>
    <!-- <div class="messenger__header__right col-9 p-1">
      <div class="messenger__header__right__container d-flex justify-content-between align-items-center p-4"></div>
    </div> -->
  </div>
  <div class="row gx-2 flex-grow-1 messenger__converstaion__container">
    <div class="messenger__list col-3 p-1 position-relative">
      <div class="messenger__list__container h-100 py-4 position-relative">
        {% if pinned_conversations_list|length != 0 %}
        <div class="">
          <p class="text-muted px-4 m-0"><b>Pinned</b></p>
        </div>
        {% endif %}
        {% for conversation in pinned_conversations_list %}
        <div data-conversation_uuid={{ conversation.conversation_uuid }}
          class="position-relative messenger__list__element d-flex p-2 px-4 {% if selected_conversation_uuid == conversation.conversation_uuid|safe %} messenger__list__element--selected{% endif %}">
          <span class=" rounded-circle overflow-hidden">
            <img width="50" height="50"
              src="https://api.dicebear.com/9.x/initials/svg?seed={{ conversation.conversation_name }}" alt="" />
          </span>
          <span class="d-flex align-items-center ml-2"><b>{{ conversation.conversation_name }}</b></span>
          <span data-conversation_uuid="{{conversation.conversation_uuid}}" class="conversation__pin position-absolute">
            <button class="btn">
              <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.75191 6.73289L11.1969 8.17793C11.2355 8.1273 11.2723 8.07415 11.3071 8.01845L14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C15.8462 12.6481 15.793 12.6848 15.7424 12.7234L17.1874 14.1684L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79852L17.1218 1.87023Z"
                  fill="#f8f5f1" />
                <path
                  d="M3.56525 8.85242C3.6015 8.26612 3.84962 7.68582 4.32883 7.27422L5.77735 8.72274C5.75784 8.72967 5.73835 8.7368 5.71886 8.74414C5.64516 8.7719 5.61855 8.80285 5.60548 8.82181C5.58877 8.84604 5.56651 8.8937 5.56144 8.97583C5.55046 9.15333 5.62872 9.40686 5.82846 9.6066L14.3137 18.0919C14.5135 18.2916 14.767 18.3699 14.9445 18.3589C15.0266 18.3538 15.0743 18.3316 15.0985 18.3149C15.1175 18.3018 15.1484 18.2752 15.1762 18.2015C15.1835 18.182 15.1907 18.1625 15.1976 18.143L16.6461 19.5915C16.2345 20.0707 15.6542 20.3188 15.0679 20.3551C14.2853 20.4035 13.4808 20.0874 12.8995 19.5061L9.36397 15.9705L2.68394 22.6506C2.29342 23.0411 1.66025 23.0411 1.26973 22.6506C0.879206 22.26 0.879206 21.6269 1.26973 21.2363L7.94975 14.5563L4.41425 11.0208C3.83293 10.4395 3.51687 9.63502 3.56525 8.85242Z"
                  fill="#f8f5f1" />
                <path
                  d="M2.00789 2.00786C1.61736 2.39838 1.61736 3.03155 2.00789 3.42207L20.5862 22.0004C20.9767 22.3909 21.6099 22.3909 22.0004 22.0004C22.391 21.6099 22.391 20.9767 22.0004 20.5862L3.4221 2.00786C3.03158 1.61733 2.39841 1.61733 2.00789 2.00786Z"
                  fill="#f8f5f1" />
              </svg>
            </button>
          </span>
        </div>
        {% endfor %}
        <div class="">
          <p class="text-muted px-4 m-0"><b>Private</b></p>
        </div>
        {% for conversation in private_conversations_list %}
        <div data-conversation_uuid={{ conversation.conversation_uuid }}
          class="position-relative messenger__list__element d-flex p-2 px-4 {% if selected_conversation_uuid == conversation.conversation_uuid|safe %} messenger__list__element--selected{% endif %}">
          <span class=" rounded-circle overflow-hidden">
            <img width="50" height="50"
              src="https://api.dicebear.com/9.x/initials/svg?seed={{ conversation.conversation_name }}" alt="" />
          </span>
          <span class="d-flex align-items-center ml-2"><b>{{ conversation.conversation_name }}</b></span>
          <span data-conversation_uuid="{{conversation.conversation_uuid}}"
            class="conversation__pin position-absolute right-0 ">
            <button class="btn">
              <svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M17.1218 1.87023C15.7573 0.505682 13.4779 0.76575 12.4558 2.40261L9.61062 6.95916C9.61033 6.95965 9.60913 6.96167 9.6038 6.96549C9.59728 6.97016 9.58336 6.97822 9.56001 6.9848C9.50899 6.99916 9.44234 6.99805 9.38281 6.97599C8.41173 6.61599 6.74483 6.22052 5.01389 6.87251C4.08132 7.22378 3.61596 8.03222 3.56525 8.85243C3.51687 9.63502 3.83293 10.4395 4.41425 11.0208L7.94975 14.5563L1.26973 21.2363C0.879206 21.6269 0.879206 22.26 1.26973 22.6506C1.66025 23.0411 2.29342 23.0411 2.68394 22.6506L9.36397 15.9705L12.8995 19.5061C13.4808 20.0874 14.2853 20.4035 15.0679 20.3551C15.8881 20.3044 16.6966 19.839 17.0478 18.9065C17.6998 17.1755 17.3043 15.5086 16.9444 14.5375C16.9223 14.478 16.9212 14.4114 16.9355 14.3603C16.9421 14.337 16.9502 14.3231 16.9549 14.3165C16.9587 14.3112 16.9606 14.31 16.9611 14.3098L21.5177 11.4645C23.1546 10.4424 23.4147 8.16307 22.0501 6.79853L17.1218 1.87023ZM14.1523 3.46191C14.493 2.91629 15.2528 2.8296 15.7076 3.28445L20.6359 8.21274C21.0907 8.66759 21.0041 9.42737 20.4584 9.76806L15.9019 12.6133C14.9572 13.2032 14.7469 14.3637 15.0691 15.2327C15.3549 16.0037 15.5829 17.1217 15.1762 18.2015C15.1484 18.2752 15.1175 18.3018 15.0985 18.3149C15.0743 18.3316 15.0266 18.3538 14.9445 18.3589C14.767 18.3699 14.5135 18.2916 14.3137 18.0919L5.82846 9.6066C5.62872 9.40686 5.55046 9.15333 5.56144 8.97583C5.56651 8.8937 5.58877 8.84605 5.60548 8.82181C5.61855 8.80285 5.64516 8.7719 5.71886 8.74414C6.79869 8.33741 7.91661 8.56545 8.68762 8.85128C9.55668 9.17345 10.7171 8.96318 11.3071 8.01845L14.1523 3.46191Z"
                  fill="#f8f5f1" />
              </svg>
            </button>
          </span>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="messenger__conversation col-9 d-flex flex-column p-1">
      <div class="messenger__conversation__div p-4 flex-grow-1 d-flex flex-column justify-content-between">
        <div id="messenger__conversation__container"
          class="messenger__conversation__container d-flex flex-column-reverse flex-grow-1 pb-4">
          {% if messages|length == 0 and selected_conversation_uuid|safe != "None"%}
          <h1 id="start_conversation_message" class="text-center my-auto">Start Conversation</h1>
          {% endif %}
          {% if selected_conversation_uuid|safe == "None" %}
          <h1 class="text-center my-auto">Please select a conversation</h1>
          {% else %}
          {% for message in messages %}

          {% if message.sender.id == user_id %}
          <div class="d-flex flex-column mb-4 mr-3">
            <span class="messenger_conversation__bubble bubble__right p-3">{{ message.content }}</span>
            <span class="messenger_conversation__timestamp badge rounded-pill align-self-end">{{message.timestamp}}
            </span>
          </div>
          {% else %}
          <div class="d-flex flex-column mb-4 ml-3">
            <span class="rounded-circle overflow-hidden align-self-start mb-1">
              <img width="30" height="30"
                src="https://api.dicebear.com/9.x/initials/svg?seed={{ selected_conversation_uuid }}" alt="" />
            </span>
            <span class="messenger_conversation__bubble bubble__left br-0 p-3">{{ message.content }}</span>
            <span
              class="messenger_conversation__timestamp badge rounded-pill align-self-start">{{message.timestamp}}</span>
          </div>
          {% endif %}

          {%endfor %}

          {% endif %}

        </div>
        {% if selected_conversation_uuid|safe != "None" %}
        <div class="messenger__input d-flex flex-row align-items-center mt-2">
          <div class="messenger__input__text flex-grow-1 pr-4">
            <input id="messenger__chat__input" type="text" class="form-control rounded-pill" id="message_input"
              placeholder="Write messages......." />
          </div>
          <div class="messenger__input__button">
            <button id="messenger__chat__submit" type="button" class="btn">
              <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"
                width="25" height="25" viewBox="0 0 256 256" xml:space="preserve">
                <defs></defs>
                <g style="
                          stroke: none;
                          stroke-width: 0;
                          stroke-dasharray: none;
                          stroke-linecap: butt;
                          stroke-linejoin: miter;
                          stroke-miterlimit: 10;
                          fill: none;
                          fill-rule: nonzero;
                          opacity: 1;
                        " transform="translate(1.4065934065934016 1.4065934065934016) scale(2.81 2.81)">
                  <path
                    d="M 89.999 3.075 C 90 3.02 90 2.967 89.999 2.912 c -0.004 -0.134 -0.017 -0.266 -0.038 -0.398 c -0.007 -0.041 -0.009 -0.081 -0.018 -0.122 c -0.034 -0.165 -0.082 -0.327 -0.144 -0.484 c -0.018 -0.046 -0.041 -0.089 -0.061 -0.134 c -0.053 -0.119 -0.113 -0.234 -0.182 -0.346 C 89.528 1.382 89.5 1.336 89.469 1.29 c -0.102 -0.147 -0.212 -0.288 -0.341 -0.417 c -0.13 -0.13 -0.273 -0.241 -0.421 -0.344 c -0.042 -0.029 -0.085 -0.056 -0.129 -0.082 c -0.118 -0.073 -0.239 -0.136 -0.364 -0.191 c -0.039 -0.017 -0.076 -0.037 -0.116 -0.053 c -0.161 -0.063 -0.327 -0.113 -0.497 -0.147 c -0.031 -0.006 -0.063 -0.008 -0.094 -0.014 c -0.142 -0.024 -0.285 -0.038 -0.429 -0.041 C 87.03 0 86.983 0 86.936 0.001 c -0.141 0.003 -0.282 0.017 -0.423 0.041 c -0.035 0.006 -0.069 0.008 -0.104 0.015 c -0.154 0.031 -0.306 0.073 -0.456 0.129 L 1.946 31.709 c -1.124 0.422 -1.888 1.473 -1.943 2.673 c -0.054 1.199 0.612 2.316 1.693 2.838 l 34.455 16.628 l 16.627 34.455 C 53.281 89.344 54.334 90 55.481 90 c 0.046 0 0.091 -0.001 0.137 -0.003 c 1.199 -0.055 2.251 -0.819 2.673 -1.943 L 89.815 4.048 c 0.056 -0.149 0.097 -0.3 0.128 -0.453 c 0.008 -0.041 0.011 -0.081 0.017 -0.122 C 89.982 3.341 89.995 3.208 89.999 3.075 z M 75.086 10.672 L 37.785 47.973 L 10.619 34.864 L 75.086 10.672 z M 55.136 79.381 L 42.027 52.216 l 37.302 -37.302 L 55.136 79.381 z"
                    style="
                            stroke: none;
                            stroke-width: 1;
                            stroke-dasharray: none;
                            stroke-linecap: butt;
                            stroke-linejoin: miter;
                            stroke-miterlimit: 10;
                            fill: #f8f5f1;
                            fill-rule: nonzero;
                            opacity: 1;
                          " transform=" matrix(1 0 0 1 0 0) " stroke-linecap="round" />
                </g>
              </svg>
            </button>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}